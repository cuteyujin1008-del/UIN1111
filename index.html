<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Kakao Share</title>
  <script src="https://developers.kakao.com/sdk/js/kakao.js"></script>
  <script>
    Kakao.init("ff9ae14e50059eda1305ea6dc9c4e3cf");

    function isDetailMode() {
      return new URLSearchParams(location.search).get("detail") === "1";
    }

    function sendKakaoOnce() {
      // ğŸ” ì´ë¯¸ ê³µìœ í–ˆìœ¼ë©´ ë‹¤ì‹œ ê³µìœ í•˜ì§€ ì•ŠìŒ
      if (sessionStorage.getItem("kakao_shared") === "1") {
        return;
      }

      const qs = new URLSearchParams(location.search);
      const msg = qs.get("msg") || "";

      const url = new URL(location.href);
      url.searchParams.set("detail", "1");

      Kakao.Share.sendDefault({
        objectType: "text",
        text: msg,
        link: {
          mobileWebUrl: url.toString(),
          webUrl: url.toString()
        }
      });

      // ê³µìœ  ì™„ë£Œ í‘œì‹œ
      sessionStorage.setItem("kakao_shared", "1");
    }

    function handleLoad() {
      if (isDetailMode()) {
        // âœ… ìì„¸íˆ ë³´ê¸° â†’ PDFë¡œ ë°”ë¡œ ì´ë™
        const qs = new URLSearchParams(location.search);
        const msg = qs.get("msg") || "";

        const pdfUrl =
          "/.netlify/functions/voucher?msg=" +
          encodeURIComponent(msg);

        location.replace(pdfUrl);
      } else {
        // âœ… ìµœì´ˆ ì§„ì… â†’ ì¹´ì¹´ì˜¤ ê³µìœ  (1íšŒë§Œ)
        sendKakaoOnce();
      }
    }
  </script>
</head>
<body onload="handleLoad()"></body>
</html>
